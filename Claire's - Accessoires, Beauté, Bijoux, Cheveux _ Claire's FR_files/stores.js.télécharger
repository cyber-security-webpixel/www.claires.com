var myLatLng={};var selectedRegion='';var $loader;var Stores={findLongLat:function findLongLat(address){var url=window.SitePreferences.GOOGLE_GEOCODING_Endpoint+'?address='+address+'&region='+selectedRegion;$.ajax({url:url,type:'GET',data:{},success:function success(response){if(response.status!="ZERO_RESULTS"&&response){var latitude=response.results[0].geometry.location.lat;var longitude=response.results[0].geometry.location.lng;myLatLng={lat:latitude,lng:longitude};Stores.findNearestStoresBopis();}else{$('#store-form__location-error').show();}}});},checkInput:function checkInput(){var storeLookUpForm=document.querySelector('.store-form');var siteName=storeLookUpForm.getAttribute('data-sitename');var addressInput=document.getElementById('store-discoverer__text-input');var address=addressInput.value;var isValidZip=true;if(address.length>0){if(siteName==="Claire's EU"||siteName==="Claire's FR"){countrySelector=document.getElementById('sl-country-selector');selectedRegion=countrySelector.options[countrySelector.selectedIndex].value;}else if(siteName==="Claire's NA"||siteName==='Icing NA'){selectedRegion='US';if(address&&(!isNaN(address)||address.match(/^[0-9-]+$/))){if(address.length<=5){if(/^\d+$/.test(address)){address=address+' US';$('#store-zip-code-error').hide();}}
else{$('.store-results').hide();$('#store-zip-code-error').show();address='';isValidZip=false;}}}
if(isValidZip)
Stores.loading();Stores.findLongLat(address);}else{$('.store-discoverer__button').prop('disabled',true);}},initClickEvents:function initClickEvents(){document.querySelector('body').addEventListener('click',function(event){var target=event.target;if(target.id==='store-discoverer__button'){event.preventDefault();Stores.checkInput();}
if(target.id==='store-discoverer__gps-locator-button'){event.preventDefault();Stores.loading();Stores.getLocation();}});},initKeypressEvents:function initKeypressEvents(){document.querySelector('body').addEventListener('keypress',function(event){var target=event.target;if(target.id==='store-discoverer__text-input'){if(event.keyCode===13){event.preventDefault();Stores.checkInput();}}});},findNearestStoresBopis:function findNearestStoresBopis(){var date=new Date();var time=date.getHours()+':'+(date.getMinutes()<10?'0':'')+date.getMinutes();var pageName=window.pageContext.type.toLowerCase();let pidVar='pid',productID;if($("#"+pidVar).length!=0){productID=$('#pid').val();}
$.ajax({url:Urls.getNearestStoresBopis,type:'POST',data:{time:time,lat:myLatLng.lat,lng:myLatLng.lng,pageName:pageName,productID:productID},success:function success(response){var nearestStores=response.stores;var furthestDistance=response.furthestDistance;Stores.displayNearestStoresBopis(nearestStores,furthestDistance,pageName);}});},displayNearestStoresBopis:function displayNearestStoresBopis(nearestStores,furthestDistance,pageName){$.ajax({url:Urls.displayStoreResultsBopis,type:'POST',data:{stores:JSON.stringify(nearestStores),furthestDistance:furthestDistance,pageName:pageName?pageName:''},success:function success(res){Stores.loaded();$('#store-form__results-wrapper').html(res);Stores.initSelectStoreButton();Stores.initStoreRadioInputSelection();Stores.initFullDetailsButton()}});},initStoreRadioInputSelection:function initStoreRadioInputSelection(){$('input[name="store-result"]').on('change',function(){$('.store-results__select-button').removeAttr('disabled');});},spinnerShow:function(container){var target=(!container||$(container).length===0)?$('body'):$(container);$loader=$loader||$('.loader');if($loader.length===0){$loader=$('<div/>').addClass('loader').append($('<div/>').addClass('loader-indicator'),$('<div/>').addClass('loader-bg'));}
return $loader.appendTo(target).show();},initSelectStoreButton:function initSelectStoreButton(){var storeFieldset=$('.store-form');var selectStoreButton=$('#store-results__select-button');var $deliveryOptionBopis=$('body').find('#delivery-option-bopis');selectStoreButton.on('click',function(event){event.preventDefault();var modalStoreId=storeFieldset.find('[name="store-result"]:checked').val();$('.ui-dialog-content:visible').dialog('close');Stores.spinnerShow('#main-container').addClass('sticky sticky-plp');$.ajax({url:storeFieldset.attr('data-url'),type:'POST',data:{storeId:modalStoreId,},success:function success(res){$('#cart-v2-delivery-body').attr('data-store-id',modalStoreId);$(document).trigger('storeUpdate',modalStoreId);if($deliveryOptionBopis.length>0){$deliveryOptionBopis.prop('checked',true).trigger('change')}else{setTimeout(location.reload(),0);}
if(window.pageContext.ns==Resources.product&&($('#productIsPickupEnabled').val()!=false)){if('URLSearchParams'in window){var searchParams=new URLSearchParams(window.location.search);searchParams.set("selectedshipment",Resources.pickup_in_store);window.location.search=searchParams.toString();}}}});})},getLocation:function getLocation(){Stores.loading();if(navigator.geolocation){navigator.geolocation.getCurrentPosition(Stores.showPosition);}else{$('#store-form__location-error').show();return;}},initLocateButton:function initLocateButton(){locateButton.addEventListener('click',function(){Stores.loading();Stores.getLocation();});},initFullDetailsButton:function initFullDetailsButton(){$('.store-result__details-label').click(function(e){e.preventDefault();var $label=$(e.target).closest('.store-result__details-label');var $labelText=$label.find('.store-result__details-label-text');var $labelArrow=$label.find('.store-result__details-arrow');var $content=$label.next();$content.slideToggle(500,function(){if($content.is(':visible')){$labelText.text(Resources.HIDE_FULL_STORE_DETAILS);$labelArrow.css('transform','rotate(0deg)');}else{$labelText.text(Resources.VIEW_FULL_STORE_DETAILS);$labelArrow.css('transform','rotate(180deg)');}});});},showPosition:function(position){myLatLng={lat:position.coords.latitude,lng:position.coords.longitude};if(myLatLng){$('#store-form__location-error').hide();var url=window.SitePreferences.GOOGLE_GEOCODING_Endpoint+'?latlng='+myLatLng.lat+','+myLatLng.lng;$.ajax({url:url,type:'GET',data:{},success:function success(response){if(response.status!="ZERO_RESULTS"&&response){var addressInput=document.getElementById('store-discoverer__text-input');addressInput.value=response.results[0].address_components[2].long_name+', '+response.results[0].address_components[4].short_name;}else{$('#store-form__location-error').show();}}});Stores.findNearestStoresBopis();}else{$('#store-form__location-error').show();return;}},loaded:function loaded(){var loader=document.getElementById('store-form__loader');loader.style.display='none';},loading:function loading(){var resultsDiv=document.getElementById('store-form__results-wrapper');var errorLocationDiv=document.getElementById('store-form__location-error');var loader=document.getElementById('store-form__loader');resultsDiv.innerHTML='';errorLocationDiv.style.display='none';loader.style.display='flex';setTimeout(function(){if(loader.style.display!=='none'){loader.style.display='none';errorLocationDiv.style.display='block';}},40000);},validateStoreInputField:function validateStoreInputField(inputValue){var inputValueExp=/^[A-Za-z\d]+(?:[-\s][A-Za-z\d]+)?$/;if(inputValue.length>0){if(inputValueExp.test(inputValue)){$('.store-discoverer__button').removeAttr('disabled');$('#store-input-error-msg').hide();}else{$('.store-discoverer__button').prop('disabled',true);$('#store-input-error-msg').show();}}else{$('#store-input-error-msg').hide();$('.store-discoverer__button').prop('disabled',true);}}}
$(document).ready(function(){Stores.initClickEvents();Stores.initKeypressEvents();});$(document).on('click','#nearest-store-name-toggle-change',function(e){var storeLookUpContainer=$('#store-look-up-modal-from-header');if(storeLookUpContainer[0]){e.preventDefault();$('#store-input-error-msg').hide();storeLookUpContainer.dialog('open');var inputValue=$('#store-discoverer__text-input').val();Stores.validateStoreInputField(inputValue);}});$(document).on('input','#store-discoverer__text-input',function(e){$('#store-input-error-msg').hide();var inputValue=$(this).val();Stores.validateStoreInputField(inputValue);$('#store-zip-code-error').hide();});